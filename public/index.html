<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ContratClair ‚Äî Analysez vos contrats par IA</title>
  <meta name="description" content="Analysez et r√©√©crivez vos contrats en 30 secondes gr√¢ce √† l'IA. Gratuit pour l'analyse, abordable pour la r√©√©criture." />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- pdf.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body { background-color: #f8fafc; }

    /* Spinner */
    .spinner {
      border: 3px solid #e0e7ff;
      border-top: 3px solid #6366f1;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Drop zone */
    .drop-zone {
      border: 2px dashed #a5b4fc;
      transition: all 0.2s;
    }
    .drop-zone.drag-over {
      border-color: #6366f1;
      background: #eef2ff;
    }

    /* Card animations */
    .card-appear {
      animation: fadeUp 0.4s ease forwards;
      opacity: 0;
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .card-appear:nth-child(1) { animation-delay: 0s; }
    .card-appear:nth-child(2) { animation-delay: 0.1s; }
    .card-appear:nth-child(3) { animation-delay: 0.2s; }
    .card-appear:nth-child(4) { animation-delay: 0.3s; }

    /* Role toggle */
    .role-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 28px;
      border-radius: 9999px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid #d1d5db;
      background: white;
      color: #6b7280;
    }
    .role-btn.active {
      background: #6366f1;
      border-color: #6366f1;
      color: white;
      box-shadow: 0 4px 14px rgba(99,102,241,0.35);
    }
    .role-btn:not(.active):hover {
      border-color: #6366f1;
      color: #6366f1;
    }

    /* Tab styles */
    .tab-btn {
      padding: 8px 20px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .tab-btn.tab-active {
      background: #6366f1;
      color: white;
    }
    .tab-btn.tab-inactive {
      background: #f1f5f9;
      color: #64748b;
    }
    .tab-btn.tab-inactive:hover {
      background: #e2e8f0;
    }

    /* CTA Button gradient */
    .cta-btn {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(99,102,241,0.4);
    }
    .cta-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
      box-shadow: 0 6px 20px rgba(99,102,241,0.5);
      transform: translateY(-1px);
    }
    .cta-btn:active:not(:disabled) {
      transform: translateY(0);
    }
    .cta-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Rewrite CTA button */
    .rewrite-btn {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(99,102,241,0.4);
      color: white;
      font-weight: 700;
      font-size: 1.05rem;
      padding: 14px 32px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    .rewrite-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
      box-shadow: 0 6px 20px rgba(99,102,241,0.5);
      transform: translateY(-1px);
    }
    .rewrite-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Result card top border */
    .result-card-red    { border-top: 4px solid #ef4444; }
    .result-card-orange { border-top: 4px solid #f97316; }
    .result-card-blue   { border-top: 4px solid #3b82f6; }
    .result-card-green  { border-top: 4px solid #22c55e; }

    /* Print styles for PDF export */
    @media print {
      body > *:not(#print-area) { display: none !important; }
      #print-area {
        display: block !important;
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        background: white;
        padding: 40px;
        font-family: Georgia, serif;
        font-size: 12pt;
        line-height: 1.7;
        color: #000;
        white-space: pre-wrap;
      }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col font-sans">

  <!-- Hidden print area for PDF export -->
  <div id="print-area" style="display:none;"></div>

  <!-- ===== NAVBAR ===== -->
  <nav style="background:#0f172a;" class="sticky top-0 z-10 shadow-lg">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <span class="text-2xl">‚öñÔ∏è</span>
      <div class="flex items-baseline gap-3">
        <span class="text-xl font-bold text-white tracking-tight">ContratClair</span>
        <span class="text-sm text-slate-400 hidden sm:inline">Analyse de contrats par IA</span>
      </div>
      <span class="ml-auto text-xs font-bold px-2.5 py-1 rounded-full"
        style="background:#1e293b; color:#818cf8; border:1px solid #312e81;">v3 Beta</span>
    </div>
  </nav>

  <!-- ===== MAIN ===== -->
  <main class="flex-1 max-w-5xl mx-auto w-full px-4 py-10">

    <!-- Hero -->
    <div class="text-center mb-10">
      <h1 class="text-4xl font-extrabold text-slate-900 mb-3 leading-tight">
        Analysez votre contrat en <span style="color:#6366f1;">30 secondes</span>
      </h1>
      <p class="text-slate-500 text-lg max-w-xl mx-auto">
        D√©tectez les clauses abusives, les manques, obtenez des suggestions et faites r√©√©crire votre contrat
      </p>
    </div>

    <!-- ===== ROLE SELECTOR ===== -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-5">
      <p class="text-center text-sm font-semibold text-slate-500 uppercase tracking-widest mb-5">
        Je suis le...
      </p>
      <div class="flex justify-center gap-4 flex-wrap">
        <button id="role-client" class="role-btn active" onclick="setRole('client')">
          <span class="text-xl">üëî</span>
          <span>Le Client</span>
        </button>
        <button id="role-prestataire" class="role-btn" onclick="setRole('prestataire')">
          <span class="text-xl">üíª</span>
          <span>Le Prestataire</span>
        </button>
      </div>
      <p id="role-hint" class="text-center text-xs text-slate-400 mt-4">
        Analyse orient√©e protection du <strong>client</strong> (acheteur de la prestation)
      </p>
    </div>

    <!-- ===== INPUT SECTION ===== -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-6">

      <!-- Tab switcher ‚Äî 3 tabs -->
      <div class="flex gap-2 mb-5 flex-wrap">
        <button id="tab-text" class="tab-btn tab-active" onclick="switchTab('text')">
          üìã Texte
        </button>
        <button id="tab-pdf" class="tab-btn tab-inactive" onclick="switchTab('pdf')">
          üìÑ PDF
        </button>
        <button id="tab-create" class="tab-btn tab-inactive" onclick="switchTab('create')">
          ‚ú® Cr√©er
        </button>
      </div>

      <!-- TEXT MODE -->
      <div id="mode-text">
        <textarea
          id="contract-text"
          rows="10"
          class="w-full border border-slate-200 rounded-xl p-4 text-sm text-slate-800 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-400 placeholder-slate-400"
          style="min-height:200px;"
          placeholder="Collez votre contrat ici...&#10;&#10;Ex: Contrat de prestation de services, bail, CDI, NDA..."
        ></textarea>
        <p id="char-count" class="text-xs text-slate-400 mt-1 text-right">0 caract√®re</p>
      </div>

      <!-- PDF MODE -->
      <div id="mode-pdf" class="hidden">
        <div
          id="drop-zone"
          class="drop-zone rounded-xl p-10 text-center cursor-pointer bg-slate-50"
          onclick="document.getElementById('pdf-input').click()"
          ondragover="handleDragOver(event)"
          ondragleave="handleDragLeave(event)"
          ondrop="handleDrop(event)"
        >
          <div class="text-5xl mb-3">üìÑ</div>
          <p class="text-slate-600 font-medium mb-1">Glissez-d√©posez votre PDF ici</p>
          <p class="text-sm text-slate-400">ou cliquez pour choisir un fichier</p>
          <input type="file" id="pdf-input" accept=".pdf" class="hidden" onchange="handlePdfFile(this.files[0])" />
        </div>
        <div id="pdf-info" class="hidden mt-3 p-3 bg-indigo-50 rounded-lg flex items-center gap-3">
          <span class="text-2xl">üìé</span>
          <div>
            <p id="pdf-name" class="text-sm font-semibold text-indigo-700"></p>
            <p id="pdf-pages" class="text-xs text-indigo-500"></p>
          </div>
          <button onclick="clearPdf()" class="ml-auto text-xs text-red-400 hover:text-red-600 font-medium">‚úï Supprimer</button>
        </div>
        <p id="pdf-error" class="hidden text-sm text-red-500 mt-2"></p>
      </div>

      <!-- CREATE MODE -->
      <div id="mode-create" class="hidden space-y-4">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1.5">Type de contrat</label>
          <select id="contract-type"
            class="w-full border border-slate-200 rounded-xl p-3 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white">
            <option value="Prestation de services">Prestation de services</option>
            <option value="CDI">CDI</option>
            <option value="CDD">CDD</option>
            <option value="Bail">Bail</option>
            <option value="NDA">NDA (accord de confidentialit√©)</option>
            <option value="Autre">Autre</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1.5">D√©crivez votre situation</label>
          <textarea
            id="create-description"
            rows="6"
            class="w-full border border-slate-200 rounded-xl p-4 text-sm text-slate-800 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-400 placeholder-slate-400"
            placeholder="Ex: Je suis d√©veloppeur freelance, je vais travailler 3 mois pour une startup parisienne sur leur app mobile √† 500‚Ç¨/jour..."
          ></textarea>
        </div>
        <button
          id="generate-btn"
          onclick="generateContract()"
          class="cta-btn w-full py-4 text-white font-bold rounded-xl text-base"
        >
          ‚ú® G√©n√©rer le contrat
        </button>
        <div id="generate-loading" class="hidden flex flex-col items-center gap-3 py-4">
          <div class="spinner"></div>
          <p class="text-indigo-600 font-semibold text-sm">G√©n√©ration du contrat par Claude AI...</p>
          <p class="text-slate-400 text-xs">Cr√©ation d'un contrat juridiquement solide adapt√© √† votre situation</p>
        </div>
        <div id="generate-error" class="hidden p-4 bg-red-50 border border-red-200 rounded-xl">
          <p class="text-red-600 text-sm font-medium">‚ùå <span id="generate-error-msg"></span></p>
        </div>
      </div>

      <!-- CTA BUTTON (analyze) ‚Äî hidden in create tab -->
      <button
        id="analyze-btn"
        onclick="analyzeContract()"
        class="cta-btn mt-6 w-full py-4 text-white font-bold rounded-xl text-base"
      >
        üîç Analyser le contrat ‚Üí
      </button>

      <!-- LOADING -->
      <div id="loading" class="hidden mt-6 flex flex-col items-center gap-3 py-4">
        <div class="spinner"></div>
        <p class="text-indigo-600 font-semibold text-sm">Analyse en cours par Claude AI...</p>
        <p class="text-slate-400 text-xs">Notre expert juridique IA examine votre contrat</p>
      </div>

      <!-- ERROR -->
      <div id="error-box" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-xl">
        <p class="text-red-600 text-sm font-medium">‚ùå <span id="error-msg"></span></p>
      </div>
    </div>

    <!-- ===== RESULTS SECTION ===== -->
    <div id="results" class="hidden">
      <div class="flex items-center gap-3 mb-6">
        <h2 class="text-2xl font-bold text-slate-900">R√©sultats de l'analyse</h2>
        <span class="text-xs bg-green-100 text-green-700 font-semibold px-3 py-1 rounded-full border border-green-200">‚úì Analyse gratuite</span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

        <!-- CARD: RISQUES -->
        <div class="card-appear bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden result-card-red">
          <div class="px-5 py-4 flex items-center gap-3 border-b border-slate-100">
            <span class="text-xl">üíÄ</span>
            <h3 class="font-bold text-slate-800">Clauses risqu√©es</h3>
            <span id="risques-count"
              class="ml-auto text-xs bg-red-100 text-red-600 font-bold px-2.5 py-0.5 rounded-full"></span>
          </div>
          <div class="p-5">
            <ol id="risques-list" class="space-y-2.5 list-decimal list-inside"></ol>
          </div>
        </div>

        <!-- CARD: MANQUANTES -->
        <div class="card-appear bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden result-card-orange">
          <div class="px-5 py-4 flex items-center gap-3 border-b border-slate-100">
            <span class="text-xl">‚ö†Ô∏è</span>
            <h3 class="font-bold text-slate-800">Clauses manquantes</h3>
            <span id="manquantes-count"
              class="ml-auto text-xs bg-orange-100 text-orange-600 font-bold px-2.5 py-0.5 rounded-full"></span>
          </div>
          <div class="p-5">
            <ol id="manquantes-list" class="space-y-2.5 list-decimal list-inside"></ol>
          </div>
        </div>

        <!-- CARD: R√âSUM√â -->
        <div class="card-appear bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden result-card-blue">
          <div class="px-5 py-4 flex items-center gap-3 border-b border-slate-100">
            <span class="text-xl">üìã</span>
            <h3 class="font-bold text-slate-800">R√©sum√© du contrat</h3>
          </div>
          <div class="p-5">
            <p id="resume-text" class="text-slate-700 text-sm leading-relaxed"></p>
          </div>
        </div>

        <!-- CARD: SUGGESTIONS -->
        <div class="card-appear bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden result-card-green">
          <div class="px-5 py-4 flex items-center gap-3 border-b border-slate-100">
            <span class="text-xl">üí°</span>
            <h3 class="font-bold text-slate-800">Suggestions d'am√©lioration</h3>
            <span id="suggestions-count"
              class="ml-auto text-xs bg-green-100 text-green-600 font-bold px-2.5 py-0.5 rounded-full"></span>
          </div>
          <div class="p-5">
            <ol id="suggestions-list" class="space-y-2.5 list-decimal list-inside"></ol>
          </div>
        </div>

      </div>

      <!-- ===== FREEMIUM UPSELL ===== -->
      <div id="freemium-cta" class="mt-8 rounded-2xl overflow-hidden border border-slate-200 shadow-sm" style="background:#f8fafc;">
        <div class="p-8 text-center">
          <div class="text-4xl mb-3">üîí</div>
          <h3 class="text-xl font-extrabold text-slate-900 mb-2">‚ö° Aller plus loin</h3>
          <h4 class="text-lg font-bold text-indigo-700 mb-2">Votre contrat r√©√©crit et corrig√©</h4>
          <p class="text-slate-500 text-sm max-w-md mx-auto mb-6">
            Claude va r√©√©crire chaque clause probl√©matique et g√©n√©rer un contrat am√©lior√©, pr√™t √† signer.
          </p>
          <button
            id="rewrite-cta-btn"
            onclick="rewriteContract()"
            class="rewrite-btn"
          >
            üîÑ R√©√©crire le contrat ‚Äî 4,90‚Ç¨
          </button>
          <p class="text-xs text-slate-400 mt-3">ou inclus dans l'abonnement Pro ¬∑ 9‚Ç¨/mois</p>
        </div>
      </div>

      <!-- ===== REWRITE LOADING ===== -->
      <div id="rewrite-loading" class="hidden mt-6 flex flex-col items-center gap-3 py-6">
        <div class="spinner"></div>
        <p class="text-indigo-600 font-semibold text-sm">R√©√©criture en cours par Claude AI...</p>
        <p class="text-slate-400 text-xs">Correction de toutes les clauses probl√©matiques...</p>
      </div>

      <!-- ===== REWRITE RESULT ===== -->
      <div id="rewrite-result" class="hidden mt-6 bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
        <div class="px-6 py-4 flex items-center gap-3" style="background:#f0fdf4; border-bottom:1px solid #bbf7d0;">
          <span class="text-xl">‚úÖ</span>
          <h3 class="font-bold text-green-800 text-lg">Contrat r√©√©crit</h3>
        </div>
        <div class="p-6">
          <textarea
            id="rewritten-contract-text"
            readonly
            class="w-full border border-slate-200 rounded-xl p-4 text-sm text-slate-800 font-mono resize-none focus:outline-none bg-white"
            style="height:400px;"
          ></textarea>
          <div class="flex gap-3 mt-4 flex-wrap">
            <button
              onclick="downloadPdf()"
              class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-semibold text-white"
              style="background:#6366f1;"
            >
              üì• T√©l√©charger en PDF
            </button>
            <button
              id="copy-btn"
              onclick="copyContract()"
              class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-semibold border-2 border-slate-300 text-slate-700 hover:border-indigo-400 hover:text-indigo-600 transition-all"
            >
              üìã Copier le texte
            </button>
          </div>
        </div>
      </div>

      <!-- New analysis button -->
      <div class="mt-8 text-center">
        <button onclick="resetForm()"
          class="px-8 py-3 border-2 border-indigo-300 text-indigo-600 rounded-xl text-sm font-semibold hover:bg-indigo-50 transition-all">
          üîÑ Analyser un autre contrat
        </button>
      </div>
    </div>

    <!-- ===== GENERATED CONTRACT SECTION (for Create tab) ===== -->
    <div id="generated-result" class="hidden mt-6 bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
      <div class="px-6 py-4 flex items-center gap-3" style="background:#f0fdf4; border-bottom:1px solid #bbf7d0;">
        <span class="text-xl">‚úÖ</span>
        <h3 class="font-bold text-green-800 text-lg">Contrat g√©n√©r√©</h3>
      </div>
      <div class="p-6">
        <textarea
          id="generated-contract-text"
          readonly
          class="w-full border border-slate-200 rounded-xl p-4 text-sm text-slate-800 font-mono resize-none focus:outline-none bg-white"
          style="height:400px;"
        ></textarea>
        <div class="flex gap-3 mt-4 flex-wrap">
          <button
            onclick="downloadPdfGenerated()"
            class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-semibold text-white"
            style="background:#6366f1;"
          >
            üì• T√©l√©charger en PDF
          </button>
          <button
            id="copy-generated-btn"
            onclick="copyGeneratedContract()"
            class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-semibold border-2 border-slate-300 text-slate-700 hover:border-indigo-400 hover:text-indigo-600 transition-all"
          >
            üìã Copier le texte
          </button>
        </div>
      </div>
    </div>

  </main>

  <!-- ===== FOOTER ===== -->
  <footer class="bg-white border-t border-slate-100 mt-8">
    <div class="max-w-5xl mx-auto px-4 py-5 text-center text-xs text-slate-400">
      Propuls√© par Claude AI ‚Ä¢ ContratClair 2026 ‚Ä¢ Usage √† titre informatif, non substitut √† un conseil juridique
    </div>
  </footer>

  <script>
    // --- GLOBALS ---
    let currentTab = 'text';
    let currentRole = 'client';
    let pdfText = '';
    let lastContractText = ''; // stores the contract text used for analysis (for rewrite)

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // --- ROLE SELECTOR ---
    function setRole(role) {
      currentRole = role;
      document.getElementById('role-client').className =
        'role-btn' + (role === 'client' ? ' active' : '');
      document.getElementById('role-prestataire').className =
        'role-btn' + (role === 'prestataire' ? ' active' : '');
      document.getElementById('role-hint').innerHTML = role === 'client'
        ? 'Analyse orient√©e protection du <strong>client</strong> (acheteur de la prestation)'
        : 'Analyse orient√©e protection du <strong>prestataire</strong> (freelance / fournisseur)';
    }

    // --- TAB SWITCHING ---
    function switchTab(tab) {
      currentTab = tab;
      const tabs = ['text', 'pdf', 'create'];
      tabs.forEach(t => {
        document.getElementById('tab-' + t).className =
          'tab-btn ' + (t === tab ? 'tab-active' : 'tab-inactive');
      });

      document.getElementById('mode-text').classList.toggle('hidden', tab !== 'text');
      document.getElementById('mode-pdf').classList.toggle('hidden', tab !== 'pdf');
      document.getElementById('mode-create').classList.toggle('hidden', tab !== 'create');

      // Show/hide analyze button (not needed in create tab ‚Äî has its own button)
      document.getElementById('analyze-btn').classList.toggle('hidden', tab === 'create');
      document.getElementById('loading').classList.toggle('hidden', true);
    }

    // --- CHAR COUNT ---
    document.getElementById('contract-text').addEventListener('input', function() {
      const len = this.value.length;
      document.getElementById('char-count').textContent =
        `${len.toLocaleString('fr-FR')} caract√®re${len !== 1 ? 's' : ''}`;
    });

    // --- PDF HANDLING ---
    function handleDragOver(e) {
      e.preventDefault();
      document.getElementById('drop-zone').classList.add('drag-over');
    }
    function handleDragLeave() {
      document.getElementById('drop-zone').classList.remove('drag-over');
    }
    function handleDrop(e) {
      e.preventDefault();
      document.getElementById('drop-zone').classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file && file.type === 'application/pdf') {
        handlePdfFile(file);
      } else {
        showPdfError('Veuillez d√©poser un fichier PDF valide.');
      }
    }

    async function handlePdfFile(file) {
      if (!file) return;
      hidePdfError();
      showPdfInfo(file.name, 'Extraction du texte...');
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(item => item.str).join(' ') + '\n';
        }
        pdfText = text.trim();
        if (!pdfText) {
          showPdfError('Impossible d\'extraire le texte. Le PDF est peut-√™tre une image scann√©e.');
          clearPdfInfo();
          return;
        }
        showPdfInfo(file.name,
          `${pdf.numPages} page${pdf.numPages > 1 ? 's' : ''} ‚Ä¢ ${pdfText.length.toLocaleString('fr-FR')} caract√®res`);
      } catch (err) {
        showPdfError('Erreur lors de la lecture du PDF: ' + err.message);
        clearPdfInfo();
      }
    }

    function showPdfInfo(name, detail) {
      document.getElementById('pdf-name').textContent = name;
      document.getElementById('pdf-pages').textContent = detail;
      document.getElementById('pdf-info').classList.remove('hidden');
    }
    function clearPdfInfo() {
      document.getElementById('pdf-info').classList.add('hidden');
      pdfText = '';
    }
    function clearPdf() {
      clearPdfInfo();
      document.getElementById('pdf-input').value = '';
      hidePdfError();
    }
    function showPdfError(msg) {
      const el = document.getElementById('pdf-error');
      el.textContent = msg;
      el.classList.remove('hidden');
    }
    function hidePdfError() {
      document.getElementById('pdf-error').classList.add('hidden');
    }

    // --- ANALYSIS ---
    async function analyzeContract() {
      const btn = document.getElementById('analyze-btn');
      hideError();
      hideResults();

      let contractText = '';
      if (currentTab === 'text') {
        contractText = document.getElementById('contract-text').value.trim();
        if (!contractText) return showError('Veuillez coller le texte de votre contrat.');
        if (contractText.length < 50) return showError('Le texte est trop court pour une analyse pertinente.');
      } else {
        if (!pdfText) return showError('Veuillez uploader un fichier PDF d\'abord.');
        contractText = pdfText;
      }

      lastContractText = contractText; // save for rewrite

      btn.disabled = true;
      document.getElementById('loading').classList.remove('hidden');

      try {
        const res = await fetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contractText, role: currentRole }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur serveur');

        displayResults(data);
      } catch (err) {
        showError(err.message || 'Erreur de connexion. Veuillez r√©essayer.');
      } finally {
        btn.disabled = false;
        document.getElementById('loading').classList.add('hidden');
      }
    }

    function displayResults(data) {
      populateList('risques-list',     data.risques,      'red');
      populateList('manquantes-list',  data.manquantes,   'orange');
      populateList('suggestions-list', data.suggestions,  'green');

      document.getElementById('resume-text').textContent = data.resume;
      document.getElementById('risques-count').textContent     = data.risques.length;
      document.getElementById('manquantes-count').textContent  = data.manquantes.length;
      document.getElementById('suggestions-count').textContent = data.suggestions.length;

      // Reset rewrite section
      document.getElementById('rewrite-result').classList.add('hidden');
      document.getElementById('rewrite-loading').classList.add('hidden');
      document.getElementById('freemium-cta').classList.remove('hidden');
      const rewriteBtn = document.getElementById('rewrite-cta-btn');
      rewriteBtn.disabled = false;
      rewriteBtn.textContent = 'üîÑ R√©√©crire le contrat ‚Äî 4,90‚Ç¨';

      const resultsEl = document.getElementById('results');
      resultsEl.classList.remove('hidden');
      resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- REWRITE ---
    async function rewriteContract() {
      if (!lastContractText) return;

      const btn = document.getElementById('rewrite-cta-btn');
      btn.disabled = true;
      btn.textContent = '‚è≥ R√©√©criture en cours...';

      document.getElementById('rewrite-loading').classList.remove('hidden');
      document.getElementById('rewrite-result').classList.add('hidden');

      try {
        const res = await fetch('/api/rewrite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contractText: lastContractText, role: currentRole }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur serveur');

        document.getElementById('rewritten-contract-text').value = data.contract;
        document.getElementById('rewrite-result').classList.remove('hidden');
        document.getElementById('freemium-cta').classList.add('hidden');
        document.getElementById('rewrite-result').scrollIntoView({ behavior: 'smooth', block: 'start' });

      } catch (err) {
        btn.disabled = false;
        btn.textContent = 'üîÑ R√©√©crire le contrat ‚Äî 4,90‚Ç¨';
        showError('Erreur lors de la r√©√©criture: ' + (err.message || 'Veuillez r√©essayer.'));
      } finally {
        document.getElementById('rewrite-loading').classList.add('hidden');
      }
    }

    // --- GENERATE CONTRACT ---
    async function generateContract() {
      const btn = document.getElementById('generate-btn');
      const description = document.getElementById('create-description').value.trim();
      const contractType = document.getElementById('contract-type').value;
      const errorEl = document.getElementById('generate-error');
      const errorMsgEl = document.getElementById('generate-error-msg');

      errorEl.classList.add('hidden');

      if (!description || description.length < 20) {
        errorMsgEl.textContent = 'Veuillez d√©crire votre situation en quelques phrases.';
        errorEl.classList.remove('hidden');
        return;
      }

      btn.disabled = true;
      document.getElementById('generate-loading').classList.remove('hidden');
      document.getElementById('generated-result').classList.add('hidden');

      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ description, role: currentRole, contractType }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur serveur');

        document.getElementById('generated-contract-text').value = data.contract;
        document.getElementById('generated-result').classList.remove('hidden');
        document.getElementById('generated-result').scrollIntoView({ behavior: 'smooth', block: 'start' });

      } catch (err) {
        errorMsgEl.textContent = err.message || 'Erreur de connexion. Veuillez r√©essayer.';
        errorEl.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        document.getElementById('generate-loading').classList.add('hidden');
      }
    }

    // --- PDF DOWNLOAD ---
    function downloadPdf() {
      const text = document.getElementById('rewritten-contract-text').value;
      triggerPrint(text);
    }

    function downloadPdfGenerated() {
      const text = document.getElementById('generated-contract-text').value;
      triggerPrint(text);
    }

    function triggerPrint(text) {
      const printArea = document.getElementById('print-area');
      printArea.textContent = text;
      printArea.style.display = 'block';
      window.print();
      // Hide again after print dialog closes
      setTimeout(() => { printArea.style.display = 'none'; }, 1000);
    }

    // --- COPY TEXT ---
    async function copyContract() {
      const text = document.getElementById('rewritten-contract-text').value;
      await copyToClipboard(text, 'copy-btn');
    }

    async function copyGeneratedContract() {
      const text = document.getElementById('generated-contract-text').value;
      await copyToClipboard(text, 'copy-generated-btn');
    }

    async function copyToClipboard(text, btnId) {
      try {
        await navigator.clipboard.writeText(text);
        const btn = document.getElementById(btnId);
        const orig = btn.innerHTML;
        btn.innerHTML = '‚úÖ Copi√© !';
        btn.style.borderColor = '#22c55e';
        btn.style.color = '#16a34a';
        setTimeout(() => {
          btn.innerHTML = orig;
          btn.style.borderColor = '';
          btn.style.color = '';
        }, 2000);
      } catch {
        alert('Impossible de copier. Veuillez s√©lectionner manuellement le texte.');
      }
    }

    // --- HELPERS ---
    function populateList(listId, items, color) {
      const ol = document.getElementById(listId);
      ol.innerHTML = '';
      if (!items || items.length === 0) {
        ol.innerHTML = '<li class="text-slate-400 text-sm italic">Aucun √©l√©ment identifi√©.</li>';
        return;
      }
      const colorMap = {
        red:    'text-red-700',
        orange: 'text-orange-700',
        green:  'text-green-700',
      };
      items.forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = 'text-slate-700 text-sm leading-relaxed flex gap-2 items-start';
        li.innerHTML = `
          <span class="font-bold ${colorMap[color] || 'text-slate-500'} flex-shrink-0 mt-0.5">${idx + 1}.</span>
          <span>${escapeHtml(item)}</span>
        `;
        ol.appendChild(li);
      });
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    function showError(msg) {
      document.getElementById('error-msg').textContent = msg;
      document.getElementById('error-box').classList.remove('hidden');
    }
    function hideError() {
      document.getElementById('error-box').classList.add('hidden');
    }
    function hideResults() {
      document.getElementById('results').classList.add('hidden');
    }

    function resetForm() {
      hideResults();
      hideError();
      document.getElementById('contract-text').value = '';
      document.getElementById('char-count').textContent = '0 caract√®re';
      document.getElementById('generated-result').classList.add('hidden');
      clearPdf();
      switchTab('text');
      setRole('client');
      lastContractText = '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>
</body>
</html>
